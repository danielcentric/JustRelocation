<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NHS Service Directory - API Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .header { background: #0075c4; color: white; padding: 20px; margin: -20px -20px 20px -20px; border-radius: 8px 8px 0 0; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 4px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 4px; font-family: monospace; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .loading { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        button { background: #0075c4; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #005a94; }
        .service-card { border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 4px; }
        .tier-premium { border-left: 4px solid #ffd700; }
        .tier-featured { border-left: 4px solid #ff6b35; }
        .tier-basic { border-left: 4px solid #4ecdc4; }
        .whatsapp-btn { background: #25d366; color: white; text-decoration: none; padding: 8px 15px; border-radius: 4px; display: inline-block; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè• NHS Service Directory - Live Test</h1>
            <p>Testing the API connection and functionality</p>
        </div>

        <div class="test-section">
            <h2>üîß API Health Check</h2>
            <button onclick="testHealth()">Test Health Endpoint</button>
            <div id="healthResult" class="test-result"></div>
        </div>

        <div class="test-section">
            <h2>üè• NHS Hospitals</h2>
            <button onclick="loadHospitals()">Load Hospitals</button>
            <div id="hospitalsResult" class="test-result"></div>
            <div id="hospitalsList"></div>
        </div>

        <div class="test-section">
            <h2>üîç Service Search</h2>
            <button onclick="loadAllServices()">Load All Services</button>
            <button onclick="searchByCategory('Housing')">Search Housing</button>
            <button onclick="searchByCategory('Banking')">Search Banking</button>
            <button onclick="searchByLocation('London')">Search London</button>
            <div id="servicesResult" class="test-result"></div>
            <div id="servicesList"></div>
        </div>

        <div class="test-section">
            <h2>üì± WhatsApp Contact Test</h2>
            <button onclick="testWhatsAppContact()">Test Contact Generation</button>
            <div id="contactResult" class="test-result"></div>
        </div>

        <div class="test-section">
            <h2>üìä Platform Stats</h2>
            <button onclick="loadStats()">Load Platform Statistics</button>
            <div id="statsResult" class="test-result"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';

        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, options);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                throw new Error(`API Error: ${error.message}`);
            }
        }

        function showResult(elementId, success, data) {
            const el = document.getElementById(elementId);
            if (success) {
                el.className = 'test-result success';
                el.innerHTML = `‚úÖ Success: ${JSON.stringify(data, null, 2)}`;
            } else {
                el.className = 'test-result error';
                el.innerHTML = `‚ùå Error: ${data}`;
            }
        }

        function showLoading(elementId) {
            const el = document.getElementById(elementId);
            el.className = 'test-result loading';
            el.innerHTML = '‚è≥ Loading...';
        }

        async function testHealth() {
            showLoading('healthResult');
            try {
                const data = await apiCall('/health');
                showResult('healthResult', true, data);
            } catch (error) {
                showResult('healthResult', false, error.message);
            }
        }

        async function loadHospitals() {
            showLoading('hospitalsResult');
            try {
                const hospitals = await apiCall('/hospitals');
                showResult('hospitalsResult', true, `Found ${hospitals.length} hospitals`);

                // Display hospitals
                const listEl = document.getElementById('hospitalsList');
                listEl.innerHTML = hospitals.map(h => `
                    <div class="service-card">
                        <h4>${h.name}</h4>
                        <p><strong>City:</strong> ${h.city} | <strong>Postcode:</strong> ${h.postcode}</p>
                        <button onclick="searchNearHospital('${h.id}')">Find Services Near This Hospital</button>
                    </div>
                `).join('');
            } catch (error) {
                showResult('hospitalsResult', false, error.message);
            }
        }

        async function loadAllServices() {
            showLoading('servicesResult');
            try {
                const data = await apiCall('/services/search');
                showResult('servicesResult', true, `Found ${data.total} services`);
                displayServices(data.results);
            } catch (error) {
                showResult('servicesResult', false, error.message);
            }
        }

        async function searchByCategory(category) {
            showLoading('servicesResult');
            try {
                const data = await apiCall(`/services/search?category=${category}`);
                showResult('servicesResult', true, `Found ${data.total} ${category} services`);
                displayServices(data.results);
            } catch (error) {
                showResult('servicesResult', false, error.message);
            }
        }

        async function searchByLocation(location) {
            showLoading('servicesResult');
            try {
                const data = await apiCall(`/services/search?location=${location}`);
                showResult('servicesResult', true, `Found ${data.total} services in ${location}`);
                displayServices(data.results);
            } catch (error) {
                showResult('servicesResult', false, error.message);
            }
        }

        async function searchNearHospital(hospitalId) {
            showLoading('servicesResult');
            try {
                const data = await apiCall(`/services/near/${hospitalId}`);
                showResult('servicesResult', true, `Found ${data.services.length} services near ${data.hospital_name}`);
                displayServices(data.services);
            } catch (error) {
                showResult('servicesResult', false, error.message);
            }
        }

        function displayServices(services) {
            const listEl = document.getElementById('servicesList');
            listEl.innerHTML = services.map(service => `
                <div class="service-card tier-${service.tier}">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <h4>${service.business_name}</h4>
                            <span style="background: #${service.tier === 'premium' ? 'ffd700' : service.tier === 'featured' ? 'ff6b35' : '4ecdc4'}; color: ${service.tier === 'premium' ? 'black' : 'white'}; padding: 2px 8px; border-radius: 12px; font-size: 12px; text-transform: uppercase;">
                                ${service.tier}
                            </span>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: bold; color: #0075c4;">${service.price_range}</div>
                            <div style="color: #666;">‚≠ê ${service.rating}</div>
                        </div>
                    </div>
                    <p><strong>Category:</strong> ${service.service_category}</p>
                    <p><strong>Location:</strong> ${service.location}</p>
                    <p>${service.description}</p>
                    <div style="margin: 10px 0;">
                        ${service.features.map(f => `<span style="background: #e3f2fd; padding: 2px 6px; margin: 2px; border-radius: 4px; font-size: 12px;">‚úì ${f}</span>`).join('')}
                    </div>
                    <a href="#" onclick="contactVendor('${service.id}', '${service.business_name}')" class="whatsapp-btn">
                        üì± Contact via WhatsApp
                    </a>
                </div>
            `).join('');
        }

        async function testWhatsAppContact() {
            showLoading('contactResult');
            try {
                const contactData = {
                    vendor_id: 'service_1',
                    message: 'Test message from NHS Service Directory'
                };

                const data = await apiCall('/contact-vendor', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(contactData)
                });

                showResult('contactResult', true, data);
            } catch (error) {
                showResult('contactResult', false, error.message);
            }
        }

        async function contactVendor(vendorId, vendorName) {
            try {
                const contactData = {
                    vendor_id: vendorId,
                    message: `Hi ${vendorName}! I found your services on NHS Service Directory and I'm interested in learning more. I'm an NHS worker. Can you help me?`
                };

                const data = await apiCall('/contact-vendor', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(contactData)
                });

                // Open WhatsApp URL
                window.open(data.whatsapp_url, '_blank');
                alert(`WhatsApp contact initiated with ${data.vendor_name}!`);
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        async function loadStats() {
            showLoading('statsResult');
            try {
                const data = await apiCall('/stats');
                showResult('statsResult', true, data);
            } catch (error) {
                showResult('statsResult', false, error.message);
            }
        }

        // Auto-load health check on page load
        window.onload = function() {
            testHealth();
        };
    </script>
</body>
</html>